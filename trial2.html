<script>


    document.addEventListener('DOMContentLoaded', async () => {
        let ClientName=''
        //const loader = document.getElementById('loader');
        const clientContainer = document.querySelector('.Client-container');
        const clientID = window.location.pathname.split('/').pop();

        const fetchClientDetails = async (id) => {
            try {
const response = await fetch(`/ClientDetails/${id}`);
if (!response.ok) throw new Error('Failed to fetch client details.');
const data = await response.json();
img=data.Image ? `../uploads/images/${data.Image}`: '../Images/DummyProfile.png';
const clientInfo = document.querySelector('.Client-info');
clientInfo.querySelector('img').src =img
clientInfo.querySelector('h2').textContent = data.ClientName || 'N/A';
clientInfo.querySelector('p:nth-of-type(1)').innerHTML = `<strong>ClientID:</strong> ${data.ClientID || 'N/A'}`;
clientInfo.querySelector('p:nth-of-type(2)').innerHTML = `<strong>PhoneNumber:</strong> ${data.PhoneNumber || 'N/A'}`;
clientInfo.querySelector('p:nth-of-type(3)').innerHTML = `<strong>Address and Occupation:</strong> ${data.AddressAndOccupation || 'N/A'}`;
clientInfo.querySelector('p:nth-of-type(4)').innerHTML = `<strong>Aadhar Number:</strong> ${data.Aadhar || 'N/A'}`;
clientInfo.querySelector('p:nth-of-type(5)').innerHTML = `<strong>Aadhar Card:</strong> <a href="../uploads/aadhar/${data.AadharCard}" target="_blank">View Document</a>`;
clientInfo.querySelector('p:nth-of-type(6)').innerHTML = `<strong>PAN Number:</strong> ${data.Pan || 'N/A'}`;
clientInfo.querySelector('p:nth-of-type(7)').innerHTML = `<strong>PAN Card:</strong> <a href="../uploads/pancard/${data.PanCard}" target="_blank">View Document</a>`;
clientInfo.querySelector('p:nth-of-type(8)').innerHTML = `<strong>Comments:</strong> ${data.Comments || 'N/A'}`;
document.getElementById("TotalAmount").innerHTML = `<strong>Total Borrowing:</strong> ${data.TotalAmount || 'N/A'}`;
document.getElementById("UpdateClient").href = `/UpdateClientPage/${data.ClientID}`;
ClientName= data.ClientName;
// Fixing the deletion event listener
const deleteButton = document.getElementById("DeleteClient");
deleteButton.addEventListener("click", () => {

    if (confirm("Are you sure you want to delete this Client?")) {
        window.location.href = `/DeleteClient/${data.ClientID}`;
        alert("Deletion Done.");
    } else {
        alert("Deletion canceled.");
    }
});
}
  
            
            catch (error) {
                console.error('Client Details API Error:', error);
            }
        };

        const fetchOrderDetails = async (id) => {
            let ActiveLending = 0;
            try {
                const response = await fetch(`/OrdersDetails/${id}`);
                if (!response.ok) throw new Error('Failed to fetch order details.');
                const data = await response.json();
                const tbody = document.querySelector('.Orders-section table tbody');
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="text-center">No Orders Found</td></tr>`;
                    return;
                }

                data.forEach((order) => {
                    const row = `
                    
        <tr>
        <td>${order.OrderID || 'N/A'}</td>
        <td>₹${order.Amount?.toLocaleString('en-IN') || '0'}</td>
        <td>₹${order.ActiveAmount?.toLocaleString('en-IN') || '0'}</td>
        <td>₹${order.PayableInterest?.toLocaleString('en-IN') || '0'}</td>
        <td>${order.StartDate.split('T')[0] || 'N/A'}</td>
        <td>${order.RateOfInterest || 'N/A'}%</td>
        <td>${order.EndDate.split('T')[0] || 'N/A'}</td>
        <td><a href="../uploads/collaterals/${order.Collaterals}" target="_blank">Collaterals</td>
        <td>
            <a href="/UpdateOrderPage/${order.OrderID}" class="btn btn-primary">Update</a>
            <button onclick="confirmDelete('${order.OrderID}','${ClientName}','${order.Amount}','${order.StartDate}')" class="btn btn-danger">Close Order</button>
           <a href="/ClientEMIPage/${order.OrderID}?PayableInterest=${order.PayableInterest}&ClientName=${ClientName}" class="btn btn-primary">Recived EMI</a>
           <a href="/OrderEMIHistoryPage/${order.OrderID}" class="btn btn-primary"> EMI History</a>
         <a 
onclick="alert('Done')" 
href="/AddDueEMI/${order.OrderID}?ClientName=${ClientName}&ActiveAmount=${order.ActiveAmount}&EMIDate=${order.StartDate.split('T')[0]}&EMIAmount=${order.PayableInterest}" 
class="btn btn-primary">
 Due
</a>
        </td>
    </tr>
                
                    `; 
                    ActiveLending += order.Amount || 0;
                    tbody.innerHTML += row;
                });
                
            const ActiveLendingElement = document.getElementById("ActiveLending");
    if (ActiveLendingElement) {
        ActiveLendingElement.innerHTML = `Active Investment Amount: ₹${ActiveLending.toLocaleString('en-IN')}`;
    }
            
            } catch (error) {
                console.error('Order Details API Error:', error);
            }
        };

        try {
            await fetchClientDetails(clientID);
            await fetchOrderDetails(clientID);
        } catch (error) {
            console.error('Data Fetch Error:', error);
        } finally {
            loader.style.display = 'none';
            clientContainer.style.display = 'flex';
        }
    });



    function confirmDelete(OrderID,ClientName,Amount,StartDate) {
        // Show confirmation alert
        if (confirm("Are you sure you want to Close this Order?")) {
            // Action if user confirms
            StartDate=StartDate.split('T')[0]
            window.location.href = `/DeleteOrder/${OrderID}?ClientName=${ClientName}&Amount=${Amount}&StartDate=${StartDate}`;
            alert("Deletion Done.");
        } else {
            // Action if user cancels
            alert("Deletion canceled.");
        }
    }


</script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
</body>